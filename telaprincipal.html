<!DOCTYPE html>
<html>
    <head>
        <!--Import Google Icon Font-->
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <!--Import materialize.css-->
        <link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/>

        <!--Let browser know website is optimized for mobile-->
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <meta charset="utf-8">
        <script src="https://www.gstatic.com/firebasejs/4.9.1/firebase.js"></script>
        <script>
            // Initialize Firebase
            var config = {
              apiKey: "AIzaSyD6KajXkA3X6XZcJq6j3Vc4Fdx8Tx8_AQY",
              authDomain: "projetobd-6b214.firebaseapp.com",
              databaseURL: "https://projetobd-6b214.firebaseio.com",
              projectId: "projetobd-6b214",
              storageBucket: "projetobd-6b214.appspot.com",
              messagingSenderId: "658505320703"
            };
            firebase.initializeApp(config);
        </script>
        <style>
                /* Always set the map height explicitly to define the size of the div
                 * element that contains the map. */
                #map {
                  height: 100%;
                }
                /* Optional: Makes the sample page fill the window. */
                html, body {
                  height: 100%;
                  margin: 0;
                  padding: 0;
                }
        </style>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCE4UC-ccylo_Z0O0kZOMusXWqkYwQ-YY0&libraries=places"></script>
        <script>
            // In the following example, markers appear when the user clicks on the map.
            // Each marker is labeled with a single alphabetical character.
            var labels = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            var labelIndex = 0;
      
            function initialize() {
              var cajazeiras = {lat: -6.8899589, lng: -38.566035};
              var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 14,
                center: cajazeiras
              });
              
              var infoWindow = new google.maps.InfoWindow({map: map});
    
              // Try HTML5 geolocation.
              if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                  var pos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                  };

                  infoWindow.setPosition(pos);
                  infoWindow.setContent('Location found.');
                  map.setCenter(pos);
                }, function() {
                  handleLocationError(true, infoWindow, map.getCenter());
                });
              } else {
                // Browser doesn't support Geolocation
                handleLocationError(false, infoWindow, map.getCenter());
              }
          
              function handleLocationError(browserHasGeolocation, infoWindow, pos) {
                infoWindow.setPosition(pos);
                infoWindow.setContent(browserHasGeolocation ?
                          'Error: The Geolocation service failed.' :
                          'Error: Your browser doesn\'t support geolocation.');
              }
              // This event listener calls addMarker() when the map is clicked.
              //google.maps.event.addListener(map, 'click', function(event) {
                //addMarker(event.latLng, map);
              //});

              // Add a marker at the center of the map.
              //addMarker(cajazeiras, map);
              
              addMarkerF(map);

              google.maps.event.addListener(map,'click', function(event) {
                
                var lat = event.latLng.lat().toFixed(6);
                var lng = event.latLng.lng().toFixed(6);
                
                localStorage.setObject("ponto", []);

                var array = localStorage.getObject("ponto");
                array.push(lat);
                array.push(lng);
                localStorage.setObject("ponto", array);

                window.location.replace("teladelocalidade.html");
              

              });

              var searchBox = new google.maps.places.SearchBox(document.getElementById('boxminha'));
            	map.controls[google.maps.ControlPosition.TOP_LEFT].push(document.getElementById('boxminha'));


	            map.addListener('bounds_changed', function() {
		            searchBox.setBounds(map.getBounds());
	            });
	
	 
		
	            searchBox.addListener('places_changed', function() {
		            var places = searchBox.getPlaces();

		            if (places.length == 0) {
	    	          return;
	  	          }

	  	
	  	          var bounds = new google.maps.LatLngBounds();
	  	          places.forEach(function(place) {
	                if (!place.geometry) {
	    	  	        console.log("Returned place contains no geometry");
	      		        return;
	   		          }

	    	          if (place.geometry.viewport) {
            
                    bounds.union(place.geometry.viewport);
	    	          } else {
	      		        bounds.extend(place.geometry.location);
	    	          }
	  	          });
		            map.fitBounds(bounds);
	            });  

            }
            
            function addMarkerF(map){
              const dbRefObjec = firebase.database().ref();
	            const dbRefList = dbRefObjec.child('localidades');
              
              localStorage.setObject("listaponto", []);

              dbRefList.on('child_added', snap => {


                var position1 = {lat: parseFloat(snap.val().lat), lng: parseFloat(snap.val().lng)};
                //addMarker(position, map);
                var arrayponto = localStorage.getObject("listaponto");
                arrayponto.push(position1);
                localStorage.setObject("listaponto", arrayponto);
                
                /*const dbRefObjec15 = firebase.database().ref();
                const dbRefList15 = dbRefObjec15.child('media');

                var quantidade = 0;
                var soma = 0;
                var mediaqm = 0;
    
                dbRefList15.on('child_added', snap4 => {

                  if(snap4.val().valor != undefined){

                    quantidade += 1;
                    soma += snap4.val().valor;
                    mediaqm = soma/quantidade;
                  }

                });*/

                var marker = new google.maps.Marker({
                  position: position1,
                  //label: labels[labelIndex++ % labels.length],
                  map: map
                });

                google.maps.event.addListener(marker,'click', function(event) {
                  // coloque aqui o que você quer fazer quando clicar no marker
                  var lat = event.latLng.lat().toFixed(6);
                  var lng = event.latLng.lng().toFixed(6);
                
                  localStorage.setObject("ponto", []);

                  var array = localStorage.getObject("ponto");
                  array.push(lat);
                  array.push(lng);
                  localStorage.setObject("ponto", array);

                  window.location.replace("teladeinforma.html");
                });

              });

              dbRefList.on('child_changed', snap => {

                var position1 = {lat: parseFloat(snap.val().lat), lng: parseFloat(snap.val().lng)};
                //addMarker(position, map);
                var arrayponto = localStorage.getObject("listaponto");
                arrayponto.push(position1);
                localStorage.setObject("listaponto", arrayponto);

                var marker = new google.maps.Marker({
                  position: position1,
                  //label: labels[labelIndex++ % labels.length],
                  map: map
                });

                google.maps.event.addListener(marker,'click', function(event) {
                  // coloque aqui o que você quer fazer quando clicar no marker
                  var lat = event.latLng.lat().toFixed(6);
                  var lng = event.latLng.lng().toFixed(6);
                
                  localStorage.setObject("ponto", []);

                  var array = localStorage.getObject("ponto");
                  array.push(lat);
                  array.push(lng);
                  localStorage.setObject("ponto", array);

                  window.location.replace("teladeinforma.html");
                });

              });

            }

            google.maps.event.addDomListener(window, 'load', initialize);
          </script> 
    </head>
    <body>
      <!--
        <nav>
            <div class="nav-wrapper teal darken-2">
                <a href="#" class="brand-logo right">Avaliação de Escolas</a>
                <a href="#" data-activates="mobile-demo" class="button-collapse"><i class="material-icons">menu</i></a>
                <ul id="nav-mobile" class="left hide-on-med-and-down">
                    <li><div>
                        <a><span class="white-text name" id="name"></span></a>
                        <a><span class="white-text email" id="email"></span></a>
                    </div></li>
                    <li><a class="waves-effect" id="buttonLogout"><i class="material-icons">power_settings_new</i>Sair</a></li>
                </ul>
                <ul class="side-nav" id="mobile-demo">
                    <li><div>
                        <a><span class="white-text name" id="name"></span></a>
                        <a><span class="white-text email" id="email"></span></a>
                    </div></li>
                  <li><a class="waves-effect" id="buttonLogout"><i class="material-icons">power_settings_new</i>Sair</a></li>
                </ul>
            </div>
        </nav>-->
        <ul id="slide-out" class="side-nav teal darken-2">
            <li>
              <div class="userView">
                <a class="white-text">Nome: <span class="white-text" id="name"></span></a><br>
                <a class="white-text">Email: <span class="white-text" id="email"></span></a>
              </div>
            </li>
            <li class="red darken-1"><a class="waves-effect" id="buttonLogout"><i class="material-icons">power_settings_new</i>Sair</a></li>
          </ul>
        <div class="navbar-fixed">
            <nav>
              <div class="nav-wrapper teal darken-2" id="inicio">
                <a href="#" data-activates="slide-out" class="button-collapse show-on-large"><i class="material-icons">menu</i></a>
                <a href="#" class="brand-logo right">Avaliação de Escolas</a>
              </div>
            </nav>
        </div>
        <input type="text" id="boxminha">
        <div id="map"></div>

        <!--<script>
        function initMap() {

          var map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: -6.8899589, lng: -38.566035},
            zoom: 14
          });
          
          const dbRefObjec = firebase.database().ref();
	        const dbRefList = dbRefObjec.child('localidade');

          dbRefList.on('child_added', snap => {

            var marker = new google.maps.Marker({
              position: {lat: parseInt(snap.val().lat), lng: parseInt(snap.val().lng)},
              map: map
            });

          });

          dbRefList.on('child_changed', snap => {

            var marker = new google.maps.Marker({
              position: {lat: parseInt(snap.val().lat), lng: parseInt(snap.val().lng)},
              map: map
            });

          });

          google.maps.event.addListener(map,'click', function(event) {

            var lat = event.latLng.lat().toFixed(6);
            var lng = event.latLng.lng().toFixed(6);

            localStorage.setObject("ponto", []);

            var array = localStorage.getObject("ponto");
            array.push(lat);
            array.push(lng);
            localStorage.setObject("ponto", array);

            window.location.replace("teladelocalidade.html");

          });

            var infoWindow = new google.maps.InfoWindow({map: map});
    
            // Try HTML5 geolocation.
            if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(function(position) {
                var pos = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude
                };
    
                infoWindow.setPosition(pos);
                infoWindow.setContent('Location found.');
                map.setCenter(pos);
              }, function() {
                handleLocationError(true, infoWindow, map.getCenter());
              });
            } else {
              // Browser doesn't support Geolocation
              handleLocationError(false, infoWindow, map.getCenter());
            }
          }
    
          function handleLocationError(browserHasGeolocation, infoWindow, pos) {
            infoWindow.setPosition(pos);
            infoWindow.setContent(browserHasGeolocation ?
                                  'Error: The Geolocation service failed.' :
                                  'Error: Your browser doesn\'t support geolocation.');
          }
        </script>-->
        <!--<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCE4UC-ccylo_Z0O0kZOMusXWqkYwQ-YY0&callback=initMap"async defer></script>-->
        <!--Import jQuery before materialize.js-->
        <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
        <script type="text/javascript">
            $( document ).ready(function(){
              $(".button-collapse").sideNav();
            })
        </script>
        <script type="text/javascript" src="js/materialize.min.js"></script>
        <script type="text/javascript" src="js/localStoragePlus.js"></script>
        <script type="text/javascript" src="js/telaprincipal.js"></script>
    </body>
</html>